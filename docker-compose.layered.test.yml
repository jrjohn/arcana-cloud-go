services:
  redis-test:
    image: redis:7-alpine
    container_name: arcana-redis-layered-test
    ports:
      - "6381:6379"
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - arcana-layered-test-network

  mysql-test:
    image: mysql:8.0
    container_name: arcana-mysql-layered-test
    ports:
      - "3308:3306"
    environment:
      MYSQL_ROOT_PASSWORD: testroot
      MYSQL_DATABASE: arcana_test
      MYSQL_USER: arcana_test
      MYSQL_PASSWORD: arcana_test
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ptestroot"]
      interval: 5s
      timeout: 3s
      retries: 10
    volumes:
      - mysql-layered-test-data:/var/lib/mysql
    networks:
      - arcana-layered-test-network

  # Monolithic with gRPC protocol - Full API Testing
  monolithic-grpc:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arcana-monolithic-grpc-test
    depends_on:
      mysql-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    environment:
      # Application
      ARCANA_APP_NAME: arcana-cloud-go
      ARCANA_APP_VERSION: 1.0.0
      ARCANA_APP_ENVIRONMENT: test
      ARCANA_APP_DEBUG: "true"
      # Database - MySQL
      ARCANA_DATABASE_DRIVER: mysql
      ARCANA_DATABASE_HOST: mysql-test
      ARCANA_DATABASE_PORT: "3306"
      ARCANA_DATABASE_NAME: arcana_test
      ARCANA_DATABASE_USER: arcana_test
      ARCANA_DATABASE_PASSWORD: arcana_test
      # Redis
      ARCANA_REDIS_HOST: redis-test
      ARCANA_REDIS_PORT: "6379"
      ARCANA_REDIS_PASSWORD: ""
      # JWT
      JWT_SECRET: test-secret-key-for-testing-purposes-only-32chars
      ARCANA_JWT_ACCESS_TOKEN_DURATION: 1h
      ARCANA_JWT_REFRESH_TOKEN_DURATION: 720h
      # Deployment - Monolithic mode with gRPC
      ARCANA_DEPLOYMENT_MODE: monolithic
      ARCANA_DEPLOYMENT_LAYER: ""
      ARCANA_DEPLOYMENT_PROTOCOL: grpc
      ARCANA_SERVER_PORT: 8080
      ARCANA_GRPC_PORT: 9090
      # Plugin
      ARCANA_PLUGIN_ENABLED: "true"
      ARCANA_PLUGIN_PLUGINS_DIRECTORY: ./plugins
      ARCANA_PLUGIN_AUTO_LOAD: "false"
      ARCANA_PLUGIN_HOT_RELOAD: "false"
      # SSR
      ARCANA_SSR_ENABLED: "false"
    ports:
      - "8081:8080"
      - "9091:9090"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - arcana-layered-test-network

  # Test runner for monolithic gRPC mode
  test-runner-grpc:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: arcana-test-runner-grpc
    depends_on:
      monolithic-grpc:
        condition: service_healthy
      mysql-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    environment:
      # Application
      ARCANA_APP_NAME: arcana-cloud-go
      ARCANA_APP_VERSION: 1.0.0
      ARCANA_APP_ENVIRONMENT: test
      ARCANA_APP_DEBUG: "true"
      # Database - MySQL
      ARCANA_DATABASE_DRIVER: mysql
      ARCANA_DATABASE_HOST: mysql-test
      ARCANA_DATABASE_PORT: "3306"
      ARCANA_DATABASE_NAME: arcana_test
      ARCANA_DATABASE_USER: arcana_test
      ARCANA_DATABASE_PASSWORD: arcana_test
      # Redis
      ARCANA_REDIS_HOST: redis-test
      ARCANA_REDIS_PORT: "6379"
      ARCANA_REDIS_PASSWORD: ""
      # JWT
      JWT_SECRET: test-secret-key-for-testing-purposes-only-32chars
      ARCANA_JWT_ACCESS_TOKEN_DURATION: 1h
      ARCANA_JWT_REFRESH_TOKEN_DURATION: 720h
      # Deployment - Monolithic mode with gRPC
      ARCANA_DEPLOYMENT_MODE: monolithic
      ARCANA_DEPLOYMENT_LAYER: ""
      ARCANA_DEPLOYMENT_PROTOCOL: grpc
      # Plugin
      ARCANA_PLUGIN_ENABLED: "true"
      ARCANA_PLUGIN_PLUGINS_DIRECTORY: ./plugins
      ARCANA_PLUGIN_AUTO_LOAD: "false"
      ARCANA_PLUGIN_HOT_RELOAD: "false"
      # SSR
      ARCANA_SSR_ENABLED: "false"
      # Test environment variables
      TEST_REDIS_ADDR: redis-test:6379
      TEST_MYSQL_DSN: arcana_test:arcana_test@tcp(mysql-test:3306)/arcana_test?charset=utf8mb4&parseTime=True&loc=Local
      # API test targets
      TEST_API_HOST: monolithic-grpc
      TEST_API_PORT: 8080
      TEST_GRPC_HOST: monolithic-grpc
      TEST_GRPC_PORT: 9090
    volumes:
      - ./coverage:/app/coverage
      - ./test-reports:/app/test-reports
    networks:
      - arcana-layered-test-network

  # Repository Layer (gRPC server)
  repository-layer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arcana-repository-layer-test
    depends_on:
      mysql-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    environment:
      ARCANA_APP_NAME: arcana-cloud-go
      ARCANA_APP_VERSION: 1.0.0
      ARCANA_APP_ENVIRONMENT: test
      ARCANA_APP_DEBUG: "true"
      # Database
      ARCANA_DATABASE_DRIVER: mysql
      ARCANA_DATABASE_HOST: mysql-test
      ARCANA_DATABASE_PORT: "3306"
      ARCANA_DATABASE_NAME: arcana_test
      ARCANA_DATABASE_USER: arcana_test
      ARCANA_DATABASE_PASSWORD: arcana_test
      # Redis
      ARCANA_REDIS_HOST: redis-test
      ARCANA_REDIS_PORT: "6379"
      ARCANA_REDIS_PASSWORD: ""
      # JWT
      JWT_SECRET: test-secret-key-for-testing-purposes-only-32chars
      # Deployment - Repository layer
      ARCANA_DEPLOYMENT_MODE: layered
      ARCANA_DEPLOYMENT_LAYER: repository
      ARCANA_DEPLOYMENT_PROTOCOL: grpc
      ARCANA_SERVER_PORT: 8080
      ARCANA_GRPC_PORT: 9090
      # Plugin
      ARCANA_PLUGIN_ENABLED: "false"
      # SSR
      ARCANA_SSR_ENABLED: "false"
    ports:
      - "9190:9090"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - arcana-layered-test-network

  # Service Layer (gRPC server, calls repository)
  service-layer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arcana-service-layer-test
    depends_on:
      repository-layer:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    environment:
      ARCANA_APP_NAME: arcana-cloud-go
      ARCANA_APP_VERSION: 1.0.0
      ARCANA_APP_ENVIRONMENT: test
      ARCANA_APP_DEBUG: "true"
      # Database (needed for DAO config even in service layer)
      ARCANA_DATABASE_DRIVER: mysql
      ARCANA_DATABASE_HOST: mysql-test
      ARCANA_DATABASE_PORT: "3306"
      ARCANA_DATABASE_NAME: arcana_test
      ARCANA_DATABASE_USER: arcana_test
      ARCANA_DATABASE_PASSWORD: arcana_test
      # Redis
      ARCANA_REDIS_HOST: redis-test
      ARCANA_REDIS_PORT: "6379"
      ARCANA_REDIS_PASSWORD: ""
      # JWT
      JWT_SECRET: test-secret-key-for-testing-purposes-only-32chars
      # Deployment - Service layer
      ARCANA_DEPLOYMENT_MODE: layered
      ARCANA_DEPLOYMENT_LAYER: service
      ARCANA_DEPLOYMENT_PROTOCOL: grpc
      ARCANA_SERVER_PORT: 8081
      ARCANA_GRPC_PORT: 9091
      # gRPC client config for repository layer
      REPOSITORY_GRPC_HOST: repository-layer
      REPOSITORY_GRPC_PORT: 9090
      # Plugin
      ARCANA_PLUGIN_ENABLED: "false"
      # SSR
      ARCANA_SSR_ENABLED: "false"
    ports:
      - "9191:9091"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - arcana-layered-test-network

  # Controller Layer (HTTP server, calls service)
  controller-layer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arcana-controller-layer-test
    depends_on:
      service-layer:
        condition: service_healthy
    environment:
      ARCANA_APP_NAME: arcana-cloud-go
      ARCANA_APP_VERSION: 1.0.0
      ARCANA_APP_ENVIRONMENT: test
      ARCANA_APP_DEBUG: "true"
      # Database (needed for config)
      ARCANA_DATABASE_DRIVER: mysql
      ARCANA_DATABASE_HOST: mysql-test
      ARCANA_DATABASE_PORT: "3306"
      ARCANA_DATABASE_NAME: arcana_test
      ARCANA_DATABASE_USER: arcana_test
      ARCANA_DATABASE_PASSWORD: arcana_test
      # Redis
      ARCANA_REDIS_HOST: redis-test
      ARCANA_REDIS_PORT: "6379"
      ARCANA_REDIS_PASSWORD: ""
      # JWT
      JWT_SECRET: test-secret-key-for-testing-purposes-only-32chars
      # Deployment - Controller layer
      ARCANA_DEPLOYMENT_MODE: layered
      ARCANA_DEPLOYMENT_LAYER: controller
      ARCANA_DEPLOYMENT_PROTOCOL: grpc
      ARCANA_SERVER_PORT: 8080
      # gRPC client config for service layer
      SERVICE_GRPC_HOST: service-layer
      SERVICE_GRPC_PORT: 9091
      # Plugin
      ARCANA_PLUGIN_ENABLED: "false"
      # SSR
      ARCANA_SSR_ENABLED: "false"
    ports:
      - "8082:8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - arcana-layered-test-network

  # Test runner for layered deployment
  test-runner-layered:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: arcana-test-runner-layered
    depends_on:
      controller-layer:
        condition: service_healthy
      mysql-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    environment:
      # Application
      ARCANA_APP_NAME: arcana-cloud-go
      ARCANA_APP_VERSION: 1.0.0
      ARCANA_APP_ENVIRONMENT: test
      ARCANA_APP_DEBUG: "true"
      # Database - MySQL
      ARCANA_DATABASE_DRIVER: mysql
      ARCANA_DATABASE_HOST: mysql-test
      ARCANA_DATABASE_PORT: "3306"
      ARCANA_DATABASE_NAME: arcana_test
      ARCANA_DATABASE_USER: arcana_test
      ARCANA_DATABASE_PASSWORD: arcana_test
      # Redis
      ARCANA_REDIS_HOST: redis-test
      ARCANA_REDIS_PORT: "6379"
      ARCANA_REDIS_PASSWORD: ""
      # JWT
      JWT_SECRET: test-secret-key-for-testing-purposes-only-32chars
      ARCANA_JWT_ACCESS_TOKEN_DURATION: 1h
      ARCANA_JWT_REFRESH_TOKEN_DURATION: 720h
      # Deployment
      ARCANA_DEPLOYMENT_MODE: layered
      ARCANA_DEPLOYMENT_LAYER: ""
      ARCANA_DEPLOYMENT_PROTOCOL: grpc
      # Plugin
      ARCANA_PLUGIN_ENABLED: "false"
      # SSR
      ARCANA_SSR_ENABLED: "false"
      # Test environment variables
      TEST_REDIS_ADDR: redis-test:6379
      TEST_MYSQL_DSN: arcana_test:arcana_test@tcp(mysql-test:3306)/arcana_test?charset=utf8mb4&parseTime=True&loc=Local
      # Layered API test targets
      TEST_API_HOST: controller-layer
      TEST_API_PORT: 8080
      TEST_REPOSITORY_GRPC_HOST: repository-layer
      TEST_REPOSITORY_GRPC_PORT: 9090
      TEST_SERVICE_GRPC_HOST: service-layer
      TEST_SERVICE_GRPC_PORT: 9091
    volumes:
      - ./coverage:/app/coverage
      - ./test-reports:/app/test-reports
    networks:
      - arcana-layered-test-network

networks:
  arcana-layered-test-network:
    driver: bridge

volumes:
  mysql-layered-test-data:
